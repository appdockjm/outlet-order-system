<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlet Order Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .outlet-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .login-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #f1f1f1;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .cart-items {
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .remove-item {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .cart-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .summary-total {
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(150%);
            transition: transform 0.5s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            background: var(--secondary);
        }
        
        .notification-error {
            background: var(--danger);
        }
        
        .unit-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #e1f0fa;
            color: var(--primary);
        }
        
        .orders-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .order-card {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .order-card:last-child {
            border-bottom: none;
        }
        
        .order-card:hover {
            background: #f9f9f9;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .order-id {
            font-weight: 600;
            color: var(--primary);
        }
        
        .order-date {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .order-outlet {
            font-weight: 500;
        }
        
        .order-items {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .order-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #e8f5e8;
            color: var(--secondary);
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sync-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .pdf-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .pdf-order-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .pdf-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .pdf-items-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #333;
        }
        
        .pdf-items-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .pdf-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tab {
                min-width: 100px;
            }
            
            .pdf-order-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2><i class="fas fa-lock"></i> Outlet Order System Login</h2>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter your username">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password">
        </div>
        <button class="btn btn-primary" id="loginBtn" style="width: 100%; justify-content: center;">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <div style="margin-top: 20px; font-size: 0.9rem; color: var(--gray); text-align: center;">
            <p>Default admin credentials: admin / admin123</p>
            <p>User credentials: user1 / user123 (Outlet A)</p>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="appScreen" style="display: none;">
        <div class="container">
            <header>
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-warehouse"></i>
                        <h1>Outlet Order Management</h1>
                    </div>
                    <div class="user-info">
                        <div class="outlet-info">
                            <i class="fas fa-store"></i>
                            <span id="currentOutlet">Outlet A</span>
                        </div>
                        <div class="user-details">
                            <span id="userName">User: John Doe</span>
                            <span id="userRole" class="role-badge" style="margin-left: 10px;">Admin</span>
                            <button class="btn btn-danger" id="logoutBtn" style="width: auto; padding: 8px 15px; margin-left: 15px;">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="tabs" id="mainTabs">
                <div class="tab active" data-tab="orders">Orders</div>
                <div class="tab" data-tab="cart">Cart <span id="cartCount">(0)</span></div>
                <!-- Admin-only tabs (hidden for regular users) -->
                <div id="adminTab1" class="tab" data-tab="items" style="display: none;">Items</div>
                <div id="adminTab2" class="tab" data-tab="outlets" style="display: none;">Outlets</div>
                <div id="adminTab3" class="tab" data-tab="admin" style="display: none;">Users</div>
            </div>
            
            <!-- Orders Tab (Visible to all users) -->
            <div class="tab-content active" id="orders-tab">
                <h2>Order Management</h2>
                <div class="sync-status" id="syncStatus" style="display: none;">
                    <i class="fas fa-sync"></i>
                    <span id="syncStatusText">Syncing with Google Sheets...</span>
                </div>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="addOrderBtn">
                        <i class="fas fa-plus"></i> Create New Order
                    </button>
                    <button class="btn btn-info" id="syncOrdersBtn">
                        <i class="fas fa-sync"></i> Sync All Orders
                    </button>
                </div>
                
                <h3>Recent Orders</h3>
                <div class="orders-container" id="ordersContainer">
                    <!-- Orders will be dynamically added here -->
                </div>
            </div>
            
            <!-- Cart Tab (Visible to all users) -->
            <div class="tab-content" id="cart-tab">
                <h2>Quick Order Cart</h2>
                
                <div class="search-container">
                    <input type="text" id="itemSearch" class="search-input" placeholder="Start typing to search items...">
                    <div class="suggestions-list" id="itemSuggestions"></div>
                </div>
                
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be dynamically added here -->
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Total Items:</span>
                        <span id="totalItems">0</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-danger" id="clearCart">
                            <i class="fas fa-trash"></i> Clear Cart
                        </button>
                        <button class="btn btn-success" id="confirmOrder">
                            <i class="fas fa-check"></i> Confirm Order
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Items Tab (Admin only) -->
            <div class="tab-content" id="items-tab">
                <h2>Item Management <span class="role-badge">Admin Only</span></h2>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="addItemBtn">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                </div>
                
                <div class="form-container" id="itemForm" style="display: none;">
                    <h3 id="itemFormTitle">Add New Item</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">Item Name</label>
                            <input type="text" id="itemName" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">Category</label>
                            <input type="text" id="itemCategory" placeholder="Enter category">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemUnit">Unit</label>
                            <select id="itemUnit">
                                <option value="KGS">KGS</option>
                                <option value="PCS">PCS</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-success" id="saveItemBtn">
                                <i class="fas fa-save"></i> Save Item
                            </button>
                            <button class="btn btn-danger" id="cancelItemBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsList">
                        <!-- Items will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Outlets Tab (Admin only) -->
            <div class="tab-content" id="outlets-tab">
                <h2>Outlet Management <span class="role-badge">Admin Only</span></h2>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="addOutletBtn">
                        <i class="fas fa-plus"></i> Add New Outlet
                    </button>
                </div>
                
                <div class="form-container" id="outletForm" style="display: none;">
                    <h3 id="outletFormTitle">Add New Outlet</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="outletName">Outlet Name</label>
                            <input type="text" id="outletName" placeholder="Enter outlet name">
                        </div>
                        <div class="form-group">
                            <label for="outletLocation">Location</label>
                            <input type="text" id="outletLocation" placeholder="Enter location">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-success" id="saveOutletBtn">
                                <i class="fas fa-save"></i> Save Outlet
                            </button>
                            <button class="btn btn-danger" id="cancelOutletBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Outlet Name</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="outletsList">
                        <!-- Outlets will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Admin Tab (Admin only) -->
            <div class="tab-content" id="admin-tab">
                <h2>User Management <span class="role-badge">Admin Only</span></h2>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="addUserBtn">
                        <i class="fas fa-plus"></i> Add New User
                    </button>
                </div>
                
                <div class="form-container" id="userForm" style="display: none;">
                    <h3 id="userFormTitle">Add New User</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUserName">Full Name</label>
                            <input type="text" id="newUserName" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="newUserUsername">Username</label>
                            <input type="text" id="newUserUsername" placeholder="Enter username">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUserPassword">Password</label>
                            <input type="password" id="newUserPassword" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="newUserOutlet">Outlet</label>
                            <select id="newUserOutlet">
                                <!-- Outlets will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-success" id="saveUserBtn">
                                <i class="fas fa-save"></i> Save User
                            </button>
                            <button class="btn btn-danger" id="cancelUserBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Outlet</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <!-- Users will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- PDF Modal -->
    <div id="pdfModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Order PDF Preview</h3>
                <button class="btn btn-danger" id="closePdfModal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div id="pdfPreviewContent">
                <!-- PDF preview will be rendered here -->
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" id="printPdfBtn">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-success" id="downloadPdfBtn">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-info" id="sharePdfBtn">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>

        // Google Sheets Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzuJrLzwva8sX70xsgO_s9VxL9sc5WQaUF3KaVeyC6XWc--Dhawx0dZdRhde-zYZ5xx/exec';

        // Working Google Sheets Integration
        async function syncOrderToGoogleSheets(order) {
            if (!GOOGLE_SCRIPT_URL) {
                console.log('Google Sheets disabled - order saved locally');
                return true;
            }

            try {
                showSyncStatus('Syncing with Google Sheets...', 'pending');
                
                // Use URL parameters (GET method) - same as the test function
                const params = new URLSearchParams({
                    orderId: order.id,
                    outlet: getOutletName(order.outletId),
                    date: order.date,
                    status: order.status || 'pending',
                    items: JSON.stringify(order.items || []),
                    user: currentUser.name || 'Unknown User',
                    timestamp: new Date().toISOString(),
                    action: 'saveOrder'
                });

                const url = `${GOOGLE_SCRIPT_URL}?${params}`;
                console.log('Sending order to Google Sheets:', url);
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Google Sheets response:', result);
                    
                    if (result.status === 'SUCCESS' || result.success) {
                        showSyncStatus('✓ Synced to Google Sheets!', 'success');
                        showNotification(`Order ${order.id} saved to Google Sheets`, 'success');
                        return true;
                    } else {
                        throw new Error(result.error || 'Unknown error from Google Sheets');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Google Sheets sync failed:', error);
                showSyncStatus('✗ Sync failed - working offline', 'error');
                showNotification('Order saved locally. Google Sheets sync failed.', 'warning');
                return false;
            }
        }

        function doGet(e) {
        try {
            console.log('Full request object:', JSON.stringify(e));
            
            // Get parameters safely
            const params = (e && e.parameter) || {};
            console.log('Parameters:', params);
            
            // Handle order saving
            if (params.orderId) {
            return saveOrderToSheet(params);
            }
            
            // Simple test response
            return ContentService.createTextOutput(JSON.stringify({
            status: 'SUCCESS',
            message: 'Google Apps Script is working!',
            timestamp: new Date().toISOString(),
            yourParameters: params,
            test: true
            })).setMimeType(ContentService.MimeType.JSON);
            
        } catch (error) {
            console.error('Error:', error);
            return ContentService.createTextOutput(JSON.stringify({
            status: 'ERROR',
            error: error.toString(),
            message: 'Something went wrong'
            })).setMimeType(ContentService.MimeType.JSON);
        }
        }

        function saveOrderToSheet(params) {
        try {
            // Replace with your actual spreadsheet ID or create a new one
            let spreadsheet;
            try {
            // Try to open existing spreadsheet (replace with your ID)
            const spreadsheetId = 'YOUR_SPREADSHEET_ID_HERE';
            spreadsheet = SpreadsheetApp.openById(spreadsheetId);
            } catch (error) {
            // Create new spreadsheet if ID doesn't exist
            spreadsheet = SpreadsheetApp.create('Outlet Orders Database');
            console.log('Created new spreadsheet with ID: ' + spreadsheet.getId());
            }
            
            const sheetName = 'Orders';
            let sheet = spreadsheet.getSheetByName(sheetName);
            
            // Create sheet if it doesn't exist
            if (!sheet) {
            sheet = spreadsheet.insertSheet(sheetName);
            // Add headers
            sheet.getRange(1, 1, 1, 7).setValues([[
                'Order ID', 'Outlet', 'Date', 'Status', 'Items', 'User', 'Timestamp'
            ]]);
            console.log('Created new sheet:', sheetName);
            }
            
            // Add the new order
            const lastRow = sheet.getLastRow();
            sheet.getRange(lastRow + 1, 1, 1, 7).setValues([[
            params.orderId || 'N/A',
            params.outlet || 'N/A',
            params.date || new Date().toLocaleDateString(),
            params.status || 'pending',
            params.items || '[]',
            params.user || 'Unknown',
            new Date().toISOString()
            ]]);
            
            console.log('Order saved successfully to row:', lastRow + 1);
            
            return ContentService.createTextOutput(JSON.stringify({
            status: 'SUCCESS',
            message: 'Order saved successfully',
            orderId: params.orderId,
            row: lastRow + 1,
            spreadsheetId: spreadsheet.getId()
            })).setMimeType(ContentService.MimeType.JSON);
            
        } catch (error) {
            console.error('Error saving order:', error);
            return ContentService.createTextOutput(JSON.stringify({
            status: 'ERROR',
            error: error.toString(),
            message: 'Failed to save order'
            })).setMimeType(ContentService.MimeType.JSON);
        }
        }

        function doPost(e) {
        return doGet(e);
        }

        // Helper function to get spreadsheet ID (run this once)
        function setupSpreadsheet() {
        const spreadsheet = SpreadsheetApp.create('Outlet Orders Database');
        const sheet = spreadsheet.getActiveSheet();
        sheet.getRange(1, 1, 1, 7).setValues([[
            'Order ID', 'Outlet', 'Date', 'Status', 'Items', 'User', 'Timestamp'
        ]]);
        
        console.log('Spreadsheet created with ID: ' + spreadsheet.getId());
        return spreadsheet.getId();
        }
        
        // Database simulation
        const database = {
            users: [
                { id: 1, name: "Admin User", username: "admin", password: "admin123", outletId: 0, role: "admin" },
                { id: 2, name: "John Smith", username: "user1", password: "user123", outletId: 1, role: "user" },
                { id: 3, name: "Sarah Johnson", username: "user2", password: "user123", outletId: 2, role: "user" }
            ],
            outlets: [
                { id: 1, name: "Downtown Store", location: "Downtown" },
                { id: 2, name: "Uptown Market", location: "Uptown" },
                { id: 3, name: "Westside Shop", location: "Westside" }
            ],
            items: [
                { id: 1, name: "Sugar", category: "Groceries", unit: "KGS" },
                { id: 2, name: "Rice", category: "Groceries", unit: "KGS" },
                { id: 3, name: "Flour", category: "Groceries", unit: "KGS" },
                { id: 4, name: "Soap", category: "Personal Care", unit: "PCS" },
                { id: 5, name: "Toothpaste", category: "Personal Care", unit: "PCS" },
                { id: 6, name: "Shampoo", category: "Personal Care", unit: "PCS" },
                { id: 7, name: "Notebook", category: "Stationery", unit: "PCS" },
                { id: 8, name: "Pen", category: "Stationery", unit: "PCS" }
            ],
            orders: [],
            cart: [],
            orderCounter: {
                1: 2,
                2: 2,
                3: 1
            }
        };

        // Load data from localStorage
        function loadFromLocalStorage() {
            const savedOrders = localStorage.getItem('outletOrders');
            const savedCounter = localStorage.getItem('orderCounter');
            
            if (savedOrders) {
                database.orders = JSON.parse(savedOrders);
            }
            if (savedCounter) {
                database.orderCounter = JSON.parse(savedCounter);
            }
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('outletOrders', JSON.stringify(database.orders));
            localStorage.setItem('orderCounter', JSON.stringify(database.orderCounter));
        }

        // Current user and application state
        let currentUser = null;
        let cart = [];
        let editingId = null;
        let currentOrderId = null;
        let currentPdfOrder = null;

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const currentOutlet = document.getElementById('currentOutlet');
        const cartCount = document.getElementById('cartCount');
        const totalItems = document.getElementById('totalItems');
        const cartItems = document.getElementById('cartItems');
        const itemSearch = document.getElementById('itemSearch');
        const itemSuggestions = document.getElementById('itemSuggestions');
        const ordersContainer = document.getElementById('ordersContainer');
        const itemsList = document.getElementById('itemsList');
        const outletsList = document.getElementById('outletsList');
        const userList = document.getElementById('userList');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const clearCartBtn = document.getElementById('clearCart');
        const confirmOrderBtn = document.getElementById('confirmOrder');
        const notification = document.getElementById('notification');
        const adminTab1 = document.getElementById('adminTab1');
        const adminTab2 = document.getElementById('adminTab2');
        const adminTab3 = document.getElementById('adminTab3');
        const addOrderBtn = document.getElementById('addOrderBtn');
        const syncOrdersBtn = document.getElementById('syncOrdersBtn');
        const syncStatus = document.getElementById('syncStatus');
        const syncStatusText = document.getElementById('syncStatusText');
        const pdfModal = document.getElementById('pdfModal');
        const pdfPreviewContent = document.getElementById('pdfPreviewContent');
        const closePdfModal = document.getElementById('closePdfModal');
        const printPdfBtn = document.getElementById('printPdfBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const sharePdfBtn = document.getElementById('sharePdfBtn');

        // Form elements
        const itemForm = document.getElementById('itemForm');
        const itemFormTitle = document.getElementById('itemFormTitle');
        const itemName = document.getElementById('itemName');
        const itemCategory = document.getElementById('itemCategory');
        const itemUnit = document.getElementById('itemUnit');
        const saveItemBtn = document.getElementById('saveItemBtn');
        const cancelItemBtn = document.getElementById('cancelItemBtn');
        const addItemBtn = document.getElementById('addItemBtn');

        const outletForm = document.getElementById('outletForm');
        const outletFormTitle = document.getElementById('outletFormTitle');
        const outletName = document.getElementById('outletName');
        const outletLocation = document.getElementById('outletLocation');
        const saveOutletBtn = document.getElementById('saveOutletBtn');
        const cancelOutletBtn = document.getElementById('cancelOutletBtn');
        const addOutletBtn = document.getElementById('addOutletBtn');

        const userForm = document.getElementById('userForm');
        const userFormTitle = document.getElementById('userFormTitle');
        const newUserName = document.getElementById('newUserName');
        const newUserUsername = document.getElementById('newUserUsername');
        const newUserPassword = document.getElementById('newUserPassword');
        const newUserOutlet = document.getElementById('newUserOutlet');
        const saveUserBtn = document.getElementById('saveUserBtn');
        const cancelUserBtn = document.getElementById('cancelUserBtn');
        const addUserBtn = document.getElementById('addUserBtn');

        // Initialize the app
        function init() {
            loadFromLocalStorage();
            setupEventListeners();
        }


        async function syncAllOrdersToGoogleSheets() {
            try {
                showSyncStatus('Syncing all orders with Google Sheets...', 'pending');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const order of database.orders) {
                    try {
                        const success = await syncOrderToGoogleSheets(order);
                        if (success) successCount++;
                        else errorCount++;
                        
                        // Add delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (error) {
                        console.error(`Failed to sync order ${order.id}:`, error);
                        errorCount++;
                    }
                }
                
                if (errorCount === 0) {
                    showSyncStatus(`All ${successCount} orders synced successfully!`, 'success');
                } else {
                    showSyncStatus(`${successCount} synced, ${errorCount} failed`, 'error');
                }
                
            } catch (error) {
                console.error('Error syncing all orders:', error);
                showSyncStatus('Error syncing orders', 'error');
            }
        }

        function showSyncStatus(message, type) {
            syncStatus.style.display = 'flex';
            syncStatusText.textContent = message;
            syncStatus.className = `sync-status sync-${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
            }
        }

        // PDF Generation Functions
        function generatePDF(order) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text('ORDER CONFIRMATION', 105, 20, { align: 'center' });
            
            // Add order information
            doc.setFontSize(12);
            doc.text(`Order ID: ${order.id}`, 20, 40);
            doc.text(`Outlet: ${getOutletName(order.outletId)}`, 20, 50);
            doc.text(`Date: ${order.date}`, 20, 60);
            doc.text(`Status: ${order.status.toUpperCase()}`, 20, 70);
            
            // Add items table
            doc.autoTable({
                startY: 80,
                head: [['Item', 'Quantity', 'Unit']],
                body: order.items.map(item => [item.name, item.quantity, item.unit]),
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219] },
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 100 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 30 }
                }
            });
            
            // Add footer
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.text('Thank you for your order!', 105, finalY, { align: 'center' });
            doc.text('Generated by Outlet Order System', 105, finalY + 10, { align: 'center' });
            
            return doc;
        }

        function showPDFPreview(order) {
            currentPdfOrder = order;
            const outlet = database.outlets.find(o => o.id === order.outletId);
            
            // Generate HTML preview
            const previewHTML = `
                <div class="pdf-preview">
                    <div class="pdf-header">
                        <h2>ORDER CONFIRMATION</h2>
                    </div>
                    <div class="pdf-order-info">
                        <div>
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Outlet:</strong> ${outlet ? outlet.name : 'Unknown'}</p>
                        </div>
                        <div>
                            <p><strong>Date:</strong> ${order.date}</p>
                            <p><strong>Status:</strong> <span class="order-status status-${order.status}">${order.status}</span></p>
                        </div>
                    </div>
                    <table class="pdf-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.unit}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="pdf-footer">
                        <p>Thank you for your order!</p>
                        <p><small>Generated by Outlet Order System</small></p>
                    </div>
                </div>
            `;
            
            pdfPreviewContent.innerHTML = previewHTML;
            pdfModal.style.display = 'flex';
        }

        function downloadPDF(order) {
            const doc = generatePDF(order);
            doc.save(`order-${order.id}.pdf`);
        }

        function printPDF(order) {
            const doc = generatePDF(order);
            doc.autoPrint();
            doc.output('dataurlnewwindow');
        }

        function sharePDF(order) {
            if (navigator.share) {
                const doc = generatePDF();
                doc.getBlob(blob => {
                    const file = new File([blob], `order-${order.id}.pdf`, { type: 'application/pdf' });
                    navigator.share({
                        title: `Order ${order.id}`,
                        text: `Order confirmation for ${getOutletName(order.outletId)}`,
                        files: [file]
                    }).catch(error => {
                        console.error('Error sharing:', error);
                        showNotification('Sharing failed. Please download instead.', 'error');
                    });
                });
            } else {
                showNotification('Sharing not supported on this device. Please download the PDF.', 'warning');
                downloadPDF(order);
            }
        }

        // Helper function to get outlet name
        function getOutletName(outletId) {
            const outlet = database.outlets.find(o => o.id === outletId);
            return outlet ? outlet.name : 'Unknown';
        }

        // Login function
        function login(username, password) {
            const user = database.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                showApp();
                showNotification(`Welcome, ${user.name}!`, 'success');
                return true;
            } else {
                showNotification('Invalid username or password', 'error');
                return false;
            }
        }

        async function testGoogleSheetsConnection() {
            try {
                console.log('Testing connection to:', GOOGLE_SCRIPT_URL);
                
                // Use GET method which works better locally
                const params = new URLSearchParams({
                    test: 'true',
                    orderId: 'TEST123',
                    outlet: 'Test Outlet',
                    date: new Date().toLocaleDateString(),
                    status: 'test',
                    user: 'Test User'
                });

                const testUrl = `${GOOGLE_SCRIPT_URL}?${params}`;
                console.log('Testing URL:', testUrl);
                
                const response = await fetch(testUrl);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Connection test result:', result);
                    
                    if (result.status === 'OK' || result.success) {
                        showNotification('✓ Google Sheets connection successful!', 'success');
                        return true;
                    } else {
                        showNotification('Connection failed: ' + (result.error || 'Unknown error'), 'error');
                        return false;
                    }
                } else {
                    // Try to get error text
                    const errorText = await response.text();
                    console.error('HTTP error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('Connection test failed:', error);
                showNotification('⚠️ Google Sheets offline - working locally', 'warning');
                return false; // But don't block the app
            }
        }

        // Show the main application
        function showApp() {
            loginScreen.style.display = 'none';
            appScreen.style.display = 'block';
            
            // Update UI based on user
            userName.textContent = `User: ${currentUser.name}`;
            userRole.textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
            
            // Show/hide tabs based on user role
            if (currentUser.role === 'admin') {
                adminTab1.style.display = 'flex';
                adminTab2.style.display = 'flex';
                adminTab3.style.display = 'flex';
            } else {
                adminTab1.style.display = 'none';
                adminTab2.style.display = 'none';
                adminTab3.style.display = 'none';
                
                // For regular users, show only their outlet
                const outlet = database.outlets.find(o => o.id === currentUser.outletId);
                if (outlet) {
                    currentOutlet.textContent = outlet.name;
                }
            }

            // ✅ ADD THIS LINE TO TEST CONNECTION AFTER LOGIN
            testGoogleSheetsConnection();
                    
            // Load initial data
            loadOrders();
            if (currentUser.role === 'admin') {
                loadItems();
                loadOutlets();
                loadUsers();
            }
            updateCart();
        }

        // Logout function
        function logout() {
            currentUser = null;
            cart = [];
            appScreen.style.display = 'none';
            loginScreen.style.display = 'block';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Generate order ID based on outlet name
        function generateOrderId(outletId) {
            const outlet = database.outlets.find(o => o.id === outletId);
            if (!outlet) return 'UNKNOWN000001';
            
            // Get first 10 characters of outlet name, pad with zeros if needed
            let outletPrefix = outlet.name.substring(0, 10).toUpperCase();
            if (outletPrefix.length < 10) {
                outletPrefix = outletPrefix.padEnd(10, '0');
            }
            
            // Initialize counter for this outlet if not exists
            if (!database.orderCounter[outletId]) {
                database.orderCounter[outletId] = 1;
            }
            
            // Generate sequential number with leading zeros
            const orderNumber = database.orderCounter[outletId].toString().padStart(6, '0');
            database.orderCounter[outletId]++;
            
            return `${outletPrefix}${orderNumber}`;
        }

        // Load and display orders in scrollable container
        function loadOrders() {
            ordersContainer.innerHTML = '';
            
            // Filter orders by current user's outlet if not admin
            let userOrders = currentUser.role === 'admin' 
                ? [...database.orders] 
                : database.orders.filter(order => order.outletId === currentUser.outletId);
            
            // Sort orders by date (newest first)
            userOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (userOrders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>No orders found</p>
                    </div>
                `;
                return;
            }
            
            userOrders.forEach(order => {
                const outlet = database.outlets.find(o => o.id === order.outletId);
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                // Format items list
                const itemsText = order.items.map(item => 
                    `${item.name} (${item.quantity} ${item.unit})`
                ).join(', ');
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div>
                            <div class="order-id">${order.id}</div>
                            <div class="order-outlet">${outlet ? outlet.name : 'Unknown'}</div>
                        </div>
                        <div>
                            <div class="order-date">${order.date}</div>
                            <span class="order-status status-${order.status}">${order.status}</span>
                        </div>
                    </div>
                    <div class="order-items">
                        ${itemsText || 'No items'}
                    </div>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="btn btn-warning btn-sm edit-order" data-id="${order.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-info btn-sm pdf-order" data-id="${order.id}">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        ${currentUser.role === 'admin' ? `
                        <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ` : ''}
                    </div>
                `;
                
                ordersContainer.appendChild(orderCard);
            });
        }

        // The rest of the functions (loadItems, loadOutlets, loadUsers, updateCart, etc.)
        // remain the same as in the previous implementation...

        // Load and display items (admin only)
        function loadItems() {
            if (currentUser.role !== 'admin') return;
            
            itemsList.innerHTML = '';
            
            if (database.items.length === 0) {
                itemsList.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <p>No items found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            database.items.forEach(item => {
                const itemRow = document.createElement('tr');
                
                itemRow.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td><span class="unit-badge">${item.unit}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-warning btn-sm edit-item" data-id="${item.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-item" data-id="${item.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                
                itemsList.appendChild(itemRow);
            });
        }

        // Load and display outlets (admin only)
        function loadOutlets() {
            if (currentUser.role !== 'admin') return;
            
            outletsList.innerHTML = '';
            
            if (database.outlets.length === 0) {
                outletsList.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="fas fa-store"></i>
                            <p>No outlets found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            database.outlets.forEach(outlet => {
                const outletRow = document.createElement('tr');
                
                outletRow.innerHTML = `
                    <td>${outlet.name}</td>
                    <td>${outlet.location}</td>
                    <td class="action-buttons">
                        <button class="btn btn-warning btn-sm edit-outlet" data-id="${outlet.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-outlet" data-id="${outlet.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                
                outletsList.appendChild(outletRow);
            });
            
            // Populate user outlet dropdown
            newUserOutlet.innerHTML = '';
            database.outlets.forEach(outlet => {
                const option = document.createElement('option');
                option.value = outlet.id;
                option.textContent = outlet.name;
                newUserOutlet.appendChild(option);
            });
        }

        // Load and display users (admin only)
        function loadUsers() {
            if (currentUser.role !== 'admin') return;
            
            userList.innerHTML = '';
            
            if (database.users.length === 0) {
                userList.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No users found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            database.users.forEach(user => {
                const userRow = document.createElement('tr');
                const outlet = database.outlets.find(o => o.id === user.outletId);
                
                userRow.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${outlet ? outlet.name : 'Admin'}</td>
                    <td>${user.role}</td>
                    <td class="action-buttons">
                        ${user.role !== 'admin' ? `
                        <button class="btn btn-warning btn-sm edit-user" data-id="${user.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-user" data-id="${user.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ` : ''}
                    </td>
                `;
                
                userList.appendChild(userRow);
            });
        }

        // Update cart display
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your cart is empty</h3>
                        <p>Search and add items to get started</p>
                    </div>
                `;
            } else {
                cart.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    
                    cartItem.innerHTML = `
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name} <span class="unit-badge">${item.unit}</span></div>
                            <div class="cart-item-quantity">
                                <input type="number" class="quantity-input" value="${item.quantity}" min="0.1" step="${item.unit === 'KGS' ? '0.1' : '1'}" data-id="${item.id}">
                                <button class="remove-item" data-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    cartItems.appendChild(cartItem);
                });
            }
            
            // Update cart count
            cartCount.textContent = `(${cart.length})`;
            totalItems.textContent = cart.length;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login
            loginBtn.addEventListener('click', () => {
                const username = usernameInput.value;
                const password = passwordInput.value;
                
                if (username && password) {
                    login(username, password);
                } else {
                    showNotification('Please enter both username and password', 'error');
                }
            });
            
            // Allow login with Enter key
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
            
            // Logout
            logoutBtn.addEventListener('click', logout);
            

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Sync orders
            syncOrdersBtn.addEventListener('click', syncAllOrdersToGoogleSheets);
            
            // PDF Modal handlers
            closePdfModal.addEventListener('click', () => {
                pdfModal.style.display = 'none';
            });
            
            printPdfBtn.addEventListener('click', () => {
                if (currentPdfOrder) {
                    printPDF(currentPdfOrder);
                }
            });
            
            downloadPdfBtn.addEventListener('click', () => {
                if (currentPdfOrder) {
                    downloadPDF(currentPdfOrder);
                }
            });
            
            sharePdfBtn.addEventListener('click', () => {
                if (currentPdfOrder) {
                    sharePDF(currentPdfOrder);
                }
            });
            
            // Close modal when clicking outside
            pdfModal.addEventListener('click', (e) => {
                if (e.target === pdfModal) {
                    pdfModal.style.display = 'none';
                }
            });

            // The rest of the event listeners remain the same...
            // Item search with autocomplete
            itemSearch.addEventListener('input', () => {
                const searchTerm = itemSearch.value.toLowerCase();
                
                if (searchTerm.length < 2) {
                    itemSuggestions.style.display = 'none';
                    return;
                }
                
                const filteredItems = database.items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.category.toLowerCase().includes(searchTerm)
                );
                
                if (filteredItems.length === 0) {
                    itemSuggestions.style.display = 'none';
                    return;
                }
                
                itemSuggestions.innerHTML = '';
                filteredItems.forEach(item => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    
                    // Create quantity input for the suggestion
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.min = item.unit === 'KGS' ? '0.1' : '1';
                    quantityInput.step = item.unit === 'KGS' ? '0.1' : '1';
                    quantityInput.value = item.unit === 'KGS' ? '1.0' : '1';
                    quantityInput.style.width = '60px';
                    quantityInput.style.padding = '5px';
                    quantityInput.style.border = '1px solid #ddd';
                    quantityInput.style.borderRadius = '3px';
                    
                    suggestion.innerHTML = `
                        <span>${item.name} (${item.category}) - ${item.unit}</span>
                    `;
                    suggestion.appendChild(quantityInput);
                    
                    const addButton = document.createElement('button');
                    addButton.className = 'btn btn-success btn-sm';
                    addButton.innerHTML = '<i class="fas fa-plus"></i> Add';
                    addButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const quantity = parseFloat(quantityInput.value);
                        if (quantity > 0) {
                            addToCart(item.id, quantity);
                            itemSearch.value = '';
                            itemSuggestions.style.display = 'none';
                        }
                    });
                    
                    suggestion.appendChild(addButton);
                    itemSuggestions.appendChild(suggestion);
                });
                
                itemSuggestions.style.display = 'block';
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!itemSearch.contains(e.target) && !itemSuggestions.contains(e.target)) {
                    itemSuggestions.style.display = 'none';
                }
            });
            
            // Clear cart
            clearCartBtn.addEventListener('click', () => {
                cart = [];
                currentOrderId = null;
                updateCart();
                showNotification('Cart cleared', 'success');
            });
            
            // Confirm order
            confirmOrderBtn.addEventListener('click', async () => {
                if (cart.length === 0) {
                    showNotification('Cart is empty', 'error');
                    return;
                }
                
                // Determine outlet ID
                let outletId;
                if (currentUser.role === 'admin') {
                    // For admin, use the first outlet or prompt for selection
                    outletId = database.outlets[0]?.id || 1;
                } else {
                    outletId = currentUser.outletId;
                }
                
                if (currentOrderId) {
                    // Update existing order
                    const orderIndex = database.orders.findIndex(o => o.id === currentOrderId);
                    if (orderIndex !== -1) {
                        database.orders[orderIndex].items = [...cart];
                        database.orders[orderIndex].date = new Date().toLocaleDateString();
                        saveToLocalStorage();
                        
                        // Sync to Google Sheets
                        await syncOrderToGoogleSheets(database.orders[orderIndex]);
                        
                        showNotification(`Order ${currentOrderId} updated successfully!`, 'success');
                    }
                } else {
                    // Create new order
                    const orderId = generateOrderId(outletId);
                    const newOrder = {
                        id: orderId,
                        outletId: outletId,
                        date: new Date().toLocaleDateString(),
                        createdAt: new Date(),
                        items: [...cart],
                        status: 'pending'
                    };
                    
                    database.orders.push(newOrder);
                    saveToLocalStorage();
                    
                    // Sync to Google Sheets
                    await syncOrderToGoogleSheets(newOrder);
                    
                    showNotification(`Order ${orderId} created successfully!`, 'success');
                }
                
                cart = [];
                currentOrderId = null;
                updateCart();
                loadOrders();
                
                // Switch to orders tab
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                document.querySelector('.tab[data-tab="orders"]').classList.add('active');
                document.getElementById('orders-tab').classList.add('active');
            });
            
            // Create new order
            addOrderBtn.addEventListener('click', () => {
                cart = [];
                currentOrderId = null;
                updateCart();
                
                // Switch to cart tab
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                document.querySelector('.tab[data-tab="cart"]').classList.add('active');
                document.getElementById('cart-tab').classList.add('active');
                
                showNotification('Ready to create new order. Search and add items to cart.', 'success');
            });
            
            // Edit and delete handlers for orders
            ordersContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-order') || e.target.parentElement.classList.contains('edit-order')) {
                    const orderId = e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id');
                    const order = database.orders.find(o => o.id === orderId);
                    
                    if (order) {
                        // Check if user has permission to edit this order
                        if (currentUser.role !== 'admin' && order.outletId !== currentUser.outletId) {
                            showNotification('You can only edit orders from your outlet', 'error');
                            return;
                        }
                        
                        // Load order items into cart
                        cart = [...order.items];
                        currentOrderId = orderId;
                        updateCart();
                        
                        // Switch to cart tab
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(tc => tc.classList.remove('active'));
                        
                        document.querySelector('.tab[data-tab="cart"]').classList.add('active');
                        document.getElementById('cart-tab').classList.add('active');
                        
                        showNotification(`Editing order ${orderId}. Make changes and confirm to update.`, 'success');
                    }
                }
                
                if (e.target.classList.contains('pdf-order') || e.target.parentElement.classList.contains('pdf-order')) {
                    const orderId = e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id');
                    const order = database.orders.find(o => o.id === orderId);
                    
                    if (order) {
                        showPDFPreview(order);
                    }
                }
                
                if (e.target.classList.contains('delete-order') || e.target.parentElement.classList.contains('delete-order')) {
                    if (currentUser.role !== 'admin') return;
                    
                    const orderId = e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id');
                    database.orders = database.orders.filter(o => o.id !== orderId);
                    saveToLocalStorage();
                    loadOrders();
                    showNotification('Order deleted successfully', 'success');
                }
            });

            // ... rest of the existing event listeners for items, outlets, users, etc.
            // Item form handlers (admin only)
            addItemBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                editingId = null;
                itemFormTitle.textContent = 'Add New Item';
                itemForm.style.display = 'block';
                itemName.value = '';
                itemCategory.value = '';
                itemUnit.value = 'KGS';
            });
            
            saveItemBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                const name = itemName.value.trim();
                const category = itemCategory.value.trim();
                const unit = itemUnit.value;
                
                if (!name || !category) {
                    showNotification('Please fill all required fields', 'error');
                    return;
                }
                
                if (editingId) {
                    // Update existing item
                    const itemIndex = database.items.findIndex(i => i.id === editingId);
                    if (itemIndex !== -1) {
                        database.items[itemIndex].name = name;
                        database.items[itemIndex].category = category;
                        database.items[itemIndex].unit = unit;
                        showNotification('Item updated successfully', 'success');
                    }
                } else {
                    // Add new item
                    const newItem = {
                        id: database.items.length + 1,
                        name: name,
                        category: category,
                        unit: unit
                    };
                    database.items.push(newItem);
                    showNotification('Item created successfully', 'success');
                }
                
                itemForm.style.display = 'none';
                loadItems();
            });
            
            cancelItemBtn.addEventListener('click', () => {
                itemForm.style.display = 'none';
            });
            
            // Outlet form handlers (admin only)
            addOutletBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                editingId = null;
                outletFormTitle.textContent = 'Add New Outlet';
                outletForm.style.display = 'block';
                outletName.value = '';
                outletLocation.value = '';
            });
            
            saveOutletBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                const name = outletName.value.trim();
                const location = outletLocation.value.trim();
                
                if (!name || !location) {
                    showNotification('Please fill all required fields', 'error');
                    return;
                }
                
                if (editingId) {
                    // Update existing outlet
                    const outletIndex = database.outlets.findIndex(o => o.id === editingId);
                    if (outletIndex !== -1) {
                        database.outlets[outletIndex].name = name;
                        database.outlets[outletIndex].location = location;
                        showNotification('Outlet updated successfully', 'success');
                    }
                } else {
                    // Add new outlet
                    const newOutlet = {
                        id: database.outlets.length + 1,
                        name: name,
                        location: location
                    };
                    database.outlets.push(newOutlet);
                    showNotification('Outlet created successfully', 'success');
                }
                
                outletForm.style.display = 'none';
                loadOutlets();
                loadOrders();
            });
            
            cancelOutletBtn.addEventListener('click', () => {
                outletForm.style.display = 'none';
            });
            
            // User form handlers (admin only)
            addUserBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                editingId = null;
                userFormTitle.textContent = 'Add New User';
                userForm.style.display = 'block';
                newUserName.value = '';
                newUserUsername.value = '';
                newUserPassword.value = '';
                newUserOutlet.value = database.outlets[0]?.id || '';
            });
            
            saveUserBtn.addEventListener('click', () => {
                if (currentUser.role !== 'admin') return;
                const name = newUserName.value.trim();
                const username = newUserUsername.value.trim();
                const password = newUserPassword.value;
                const outletId = parseInt(newUserOutlet.value);
                
                if (!name || !username || !password || !outletId) {
                    showNotification('Please fill all required fields', 'error');
                    return;
                }
                
                // Check if username already exists
                if (database.users.find(u => u.username === username && u.id !== editingId)) {
                    showNotification('Username already exists', 'error');
                    return;
                }
                
                if (editingId) {
                    // Update existing user
                    const userIndex = database.users.findIndex(u => u.id === editingId);
                    if (userIndex !== -1) {
                        database.users[userIndex].name = name;
                        database.users[userIndex].username = username;
                        database.users[userIndex].password = password;
                        database.users[userIndex].outletId = outletId;
                        showNotification('User updated successfully', 'success');
                    }
                } else {
                    // Add new user
                    const newUser = {
                        id: database.users.length + 1,
                        name: name,
                        username: username,
                        password: password,
                        outletId: outletId,
                        role: 'user'
                    };
                    database.users.push(newUser);
                    showNotification('User created successfully', 'success');
                }
                
                userForm.style.display = 'none';
                loadUsers();
            });
            
            cancelUserBtn.addEventListener('click', () => {
                userForm.style.display = 'none';
            });
            
            // Edit and delete handlers for items (admin only)
            itemsList.addEventListener('click', (e) => {
                if (currentUser.role !== 'admin') return;
                
                if (e.target.classList.contains('edit-item') || e.target.parentElement.classList.contains('edit-item')) {
                    const itemId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    const item = database.items.find(i => i.id === itemId);
                    
                    if (item) {
                        editingId = itemId;
                        itemFormTitle.textContent = 'Edit Item';
                        itemName.value = item.name;
                        itemCategory.value = item.category;
                        itemUnit.value = item.unit;
                        itemForm.style.display = 'block';
                    }
                }
                
                if (e.target.classList.contains('delete-item') || e.target.parentElement.classList.contains('delete-item')) {
                    const itemId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    database.items = database.items.filter(i => i.id !== itemId);
                    loadItems();
                    showNotification('Item deleted successfully', 'success');
                }
            });
            
            // Edit and delete handlers for outlets (admin only)
            outletsList.addEventListener('click', (e) => {
                if (currentUser.role !== 'admin') return;
                
                if (e.target.classList.contains('edit-outlet') || e.target.parentElement.classList.contains('edit-outlet')) {
                    const outletId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    const outlet = database.outlets.find(o => o.id === outletId);
                    
                    if (outlet) {
                        editingId = outletId;
                        outletFormTitle.textContent = 'Edit Outlet';
                        outletName.value = outlet.name;
                        outletLocation.value = outlet.location;
                        outletForm.style.display = 'block';
                    }
                }
                
                if (e.target.classList.contains('delete-outlet') || e.target.parentElement.classList.contains('delete-outlet')) {
                    const outletId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    database.outlets = database.outlets.filter(o => o.id !== outletId);
                    loadOutlets();
                    showNotification('Outlet deleted successfully', 'success');
                }
            });
            
            // Edit and delete handlers for users (admin only)
            userList.addEventListener('click', (e) => {
                if (currentUser.role !== 'admin') return;
                
                if (e.target.classList.contains('edit-user') || e.target.parentElement.classList.contains('edit-user')) {
                    const userId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    const user = database.users.find(u => u.id === userId);
                    
                    if (user) {
                        editingId = userId;
                        userFormTitle.textContent = 'Edit User';
                        newUserName.value = user.name;
                        newUserUsername.value = user.username;
                        newUserPassword.value = user.password;
                        newUserOutlet.value = user.outletId;
                        userForm.style.display = 'block';
                    }
                }
                
                if (e.target.classList.contains('delete-user') || e.target.parentElement.classList.contains('delete-user')) {
                    const userId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    
                    if (userId === currentUser.id) {
                        showNotification('You cannot delete your own account', 'error');
                        return;
                    }
                    
                    database.users = database.users.filter(u => u.id !== userId);
                    loadUsers();
                    showNotification('User deleted successfully', 'success');
                }
            });
            
            // Update quantity in cart
            cartItems.addEventListener('change', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    const itemId = parseInt(e.target.getAttribute('data-id'));
                    const newQuantity = parseFloat(e.target.value);
                    
                    if (newQuantity <= 0) {
                        // Remove item if quantity is 0 or negative
                        cart = cart.filter(item => item.id !== itemId);
                        showNotification('Item removed from cart', 'success');
                    } else {
                        // Update quantity
                        const cartItem = cart.find(item => item.id === itemId);
                        if (cartItem) {
                            cartItem.quantity = newQuantity;
                        }
                    }
                    
                    updateCart();
                }
            });
            
            // Remove item from cart
            cartItems.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-item') || e.target.parentElement.classList.contains('remove-item')) {
                    const itemId = parseInt(e.target.getAttribute('data-id') || e.target.parentElement.getAttribute('data-id'));
                    cart = cart.filter(item => item.id !== itemId);
                    updateCart();
                    showNotification('Item removed from cart', 'success');
                }
            });
        }

        // Add item to cart
        function addToCart(itemId, quantity = null) {
            const item = database.items.find(i => i.id === itemId);
            
            if (!item) return;
            
            // If quantity not provided, use default based on unit
            if (quantity === null) {
                quantity = item.unit === 'KGS' ? 1.0 : 1;
            }
            
            const existingItem = cart.find(cartItem => cartItem.id === itemId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: item.id,
                    name: item.name,
                    quantity: quantity,
                    unit: item.unit
                });
            }
            
            updateCart();
            showNotification(`${quantity} ${item.unit} of ${item.name} added to cart`, 'success');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
